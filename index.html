<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Stream Caster</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl p-6 bg-gray-800 rounded-2xl shadow-2xl">
    <h1 class="text-3xl font-bold mb-4 text-center">📡 Smart Stream Caster</h1>
    <p class="text-sm text-gray-400 mb-6 text-center">Enter a direct stream URL or a webpage URL to extract playable video links.</p>

    <div class="flex gap-2 mb-4">
      <input
        id="urlInput"
        type="text"
        placeholder="Enter stream or webpage URL"
        class="flex-1 px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none"
      />
      <button
        onclick="processUrl()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold"
      >Go</button>
    </div>

    <div id="linkList" class="mb-4"></div>

    <div class="aspect-w-16 aspect-h-9 w-full bg-black rounded-xl overflow-hidden">
      <video id="video" class="w-full h-full" controls></video>
    </div>
  </div>

  <script>
    async function processUrl() {
      const input = document.getElementById('urlInput').value.trim();
      const video = document.getElementById('video');
      const list = document.getElementById('linkList');
      list.innerHTML = '';

      if (!input) return alert('Please enter a URL');

      // Reset player
      video.pause();
      video.removeAttribute('src');
      video.load();

      if (window.hls) {
        window.hls.destroy();
        window.hls = null;
      }

      try {
        if (input.match(/\.txt(\?.*)?$/)) {
          const response = await fetch(input);
          const text = await response.text();
          const links = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.includes('http'));
          showLinks(links);
        } else if (input.match(/^https?:\/\/.*\.m3u8$/i) || input.match(/^https?:\/\/.*\.mp4$/i)) {
          showLinks([input]);
        } else {
          const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(input)}`);
          const result = await response.json();
          const html = result.contents;
          const matches = [...html.matchAll(/https?:[^"'\s>]+\.(m3u8|mp4)/g)].map(m => m[0]);
          const unique = [...new Set(matches)];
          if (unique.length) {
            showLinks(unique);
          } else {
            alert('No playable stream links found.');
          }
        }
      } catch (err) {
        console.error(err);
        alert('Failed to fetch or parse the content.');
      }
    }

    function showLinks(links) {
      const container = document.getElementById('linkList');
      links.forEach(link => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 mb-2';

        const btn = document.createElement('button');
        btn.textContent = '▶️ Play';
        btn.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded';
        btn.onclick = () => loadToPlayer(link);

        const copyBtn = document.createElement('button');
        copyBtn.textContent = '📋 Copy';
        copyBtn.className = 'bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded';
        copyBtn.onclick = () => navigator.clipboard.writeText(link);

        const span = document.createElement('span');
        span.className = 'flex-1 text-xs text-gray-300 truncate';
        span.textContent = link;

        row.appendChild(btn);
        row.appendChild(copyBtn);
        row.appendChild(span);
        container.appendChild(row);
      });
    }

    function loadToPlayer(url) {
      const video = document.getElementById('video');
      video.pause();
      video.removeAttribute('src');
      video.load();

      if (Hls.isSupported() && url.includes('.m3u8')) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play();
        });
        hls.on(Hls.Events.ERROR, (e, d) => {
          if (d.fatal) {
            hls.destroy();
            tryNativePlayback(url);
          }
        });
        window.hls = hls;
      } else {
        tryNativePlayback(url);
      }
    }

    function tryNativePlayback(url) {
      const video = document.getElementById('video');
      video.src = url;
      video.play().catch(err => {
        alert('Could not play the stream. Please check the link.');
        console.error(err);
      });
    }
  </script>
</body>
</html>
