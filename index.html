<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Video Player</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-start p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">ðŸŽ¥ Smart Stream Player</h1>

  <div class="w-full max-w-3xl space-y-4">
    <input id="streamUrl" type="text" placeholder="Paste stream URL or video page"
      class="w-full px-4 py-2 rounded-lg bg-gray-700 placeholder-gray-400 text-white" />

    <button onclick="handleInput()"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full font-semibold">Load</button>

    <div id="linkList" class="space-y-3"></div>

    <div class="aspect-w-16 aspect-h-9 w-full bg-black rounded-xl overflow-hidden mt-6">
      <video id="video" class="w-full h-full" controls></video>
    </div>
  </div>

  <script>
    const proxy = "https://api.allorigins.win/raw?url=";

    function isDirectLink(url) {
      return /\.(m3u8|mp4|webm|txt)(\?.*)?$/.test(url);
    }

    async function handleInput() {
      const input = document.getElementById("streamUrl").value.trim();
      const list = document.getElementById("linkList");
      list.innerHTML = "";

      if (!input) return alert("Please enter a URL.");

      if (isDirectLink(input)) {
        await handleDirectLink(input);
      } else {
        await extractLinksFromPage(input);
      }
    }

    async function handleDirectLink(url) {
      if (/\.txt(\?.*)?$/.test(url)) {
        try {
          const res = await fetch(url);
          const text = await res.text();
          const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith("#"));
          const valid = lines.find(line => /\.(m3u8|mp4)/.test(line));
          if (!valid) return alert("No playable stream found in .txt file.");
          loadToPlayer(valid);
        } catch (err) {
          alert("Failed to load the .txt file.");
        }
      } else {
        loadToPlayer(url);
      }
    }

    async function extractLinksFromPage(pageUrl) {
      const list = document.getElementById("linkList");
      try {
        const res = await fetch(proxy + encodeURIComponent(pageUrl));
        const html = await res.text();
        const links = [...html.matchAll(/https?:\/\/[^\s"'<>]+/g)]
          .map(m => m[0])
          .filter(link => /\.(m3u8|mp4|webm)(\?.*)?$/.test(link));

        if (!links.length) {
          list.innerHTML = "<p class='text-red-400'>No playable links found on page.</p>";
          return;
        }

        links.forEach(link => {
          const div = document.createElement("div");
          div.className = "bg-gray-700 rounded p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2";

          const text = document.createElement("p");
          text.className = "text-sm break-all";
          text.textContent = link;

          const actions = document.createElement("div");
          actions.className = "flex gap-2 flex-wrap";

          const playBtn = document.createElement("button");
          playBtn.textContent = "â–¶ï¸ Play";
          playBtn.className = "bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm";
          playBtn.onclick = () => loadToPlayer(link);

          const copyBtn = document.createElement("button");
          copyBtn.textContent = "ðŸ“‹ Copy";
          copyBtn.className = "bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-sm";
          copyBtn.onclick = () => navigator.clipboard.writeText(link);

          actions.append(playBtn, copyBtn);
          div.append(text, actions);
          list.appendChild(div);
        });
      } catch (err) {
        console.error("Fetch error:", err);
        alert("Failed to fetch page content. Check the URL or try another.");
      }
    }

    function loadToPlayer(url) {
      const video = document.getElementById("video");
      if (window.hls) {
        window.hls.destroy();
        window.hls = null;
      }

      video.pause();
      video.removeAttribute("src");
      video.load();

      if (Hls.isSupported() && url.includes(".m3u8")) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        window.hls = hls;
      } else {
        video.src = url;
        video.play().catch(err => {
          console.error("Playback failed:", err);
          alert("Could not play the stream.");
        });
      }
    }
  </script>
</body>
</html>
